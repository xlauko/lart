#!/bin/bash

if [ "$1" == "--version" ]; then
     echo "LART @CMAKE_PROJECT_VERSION@"
     exit 0
fi

domain=$1

SCRIPT=`realpath $0`
SCRIPTPATH=`dirname $SCRIPT`

RUNTIME="${SCRIPTPATH}/../lib/libnative.a"
DOMAIN="${SCRIPTPATH}/../lib/lib$domain.a"
PASS="${SCRIPTPATH}/../lib/liblartcc.so"
LIBCXX="${LIBCXX_DATAFLOW_DIR}"

LART_INTERFACE="${SCRIPTPATH}/../include/"

if [[ ${@:2} == *"-m32"* ]]; then
     CONCRETE_RUNTIME="${SCRIPTPATH}/../lib/libnative-concrete-i386.a"
else
     CONCRETE_RUNTIME="${SCRIPTPATH}/../lib/libnative-concrete.a"
fi

RED='\033[0;31m'
NC='\033[0m' # No Color

CFLAGS="-isystem ${LIBCXX}/include/c++/v1 -nostdlib++"
LDFLAGS="-L${LIBCXX}/lib -Wl,-rpath,${LIBCXX}/lib -lstdc++ -stdlib=libc++ -lm"

if [ -z $domain ]; then
     echo -e "${RED}[LART ERROR]${NC} No domain provided. Please specify a domain name."
     exit 1
fi

if [[ ${domain} == *"term"* ]]; then
     LINK_SOLVER="-lz3"
fi

if [[ ${domain} == "concrete" ]]; then
     exec @CLANG_BINARY@                             \
          ${@:2}                                     \
          -lm                                        \
          -lstdc++                                   \
          ${CONCRETE_RUNTIME}                        \
          -Qunused-arguments
else
     exec @CLANG_BINARY@                             \
          -Xclang -load -Xclang "$PASS"              \
          -fsanitize=dataflow                        \
          ${CFLAGS}                                  \
          ${LINK_SOLVER}                             \
          ${@:2}                                     \
          ${LDFLAGS}                                 \
          ${RUNTIME}                                 \
          ${DOMAIN}                                  \
          -I${LART_INTERFACE}                        \
          -Qunused-arguments
fi